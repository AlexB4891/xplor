<!DOCTYPE html>
<html>	
	<head>
	<meta charset="utf-8">
	<title>XploR Questionnaire Generator</title>
	
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto">
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" type="text/css" href="stylesheet.css">
	
	<script type="text/javascript" src="widget/raphael.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="widget/rankedChoiceInput.js"></script>
	
	<script>

	$(document).click(function(event) 
	{
		if ($(event.target).closest('form').length == 0) {
			$('.focused').removeClass('focused');
		}
	});
	
	$(document).ready(function() {
		var choicesText = {strings: ["Alternativ 1"],
							positions: [4],
							font_size: 13,
							font_family: 'Roboto',
							padding: [15, 5]
		};

		var scaleText = {strings: ["Dåligt", "Varken eller", "Bra"],
						positions: [0, 50, 100],
						font_size: 18,
						font_family: 'Roboto'};


		var gradients = {fill: ["0-#00ff00-#fff", "0-#fff-#ff0000"],
						positions: [[50, 0], [50, 100]]};

		var width = $('#myForm').width();
		createRankedChoiceInput($('.question-type-ranked-choice')[0], width, 100, 7, choicesText, scaleText, gradients);
	});

	function isInPreviewMode() 
	{
		return $("#toolbar button[onclick='preview()']").hasClass('active');	
	}
	
	function submitQuestionnaire() 
	{
		// readData();
		// saveData();
		alert('Success');
	}

	function addAnswerAlternative(element) 
	{
		var number_of_alternatives = $(element).siblings('div').length;
		var cloned_alternative = $(element).siblings('div:last').clone();
		var question_number = $(element).closest('form').attr('data-question-no');
		var alternative_name = 'question_' + question_number;
		var alternative_id = alternative_name + '_alt_' + (number_of_alternatives + 1);
		
		$(cloned_alternative).children('input').attr({'name': alternative_name, 'id': alternative_id});
		$(cloned_alternative).children('label').attr('for', alternative_id);
		// $(cloned_alternative).find("span[class='question-type-alternative-number']").text('' + (number_of_alternatives + 1));
		
		$(element).before(cloned_alternative);
	}

	function removeQuestionAlternative(element) 
	{
		$(element).parent().remove();
	}

	function switchFocusedSection(element) 
	{
		if (isInPreviewMode() == false) {
			var focused_form = $(element).closest('form');

			$('.focused').removeClass('focused');
			$(focused_form).addClass('focused');
		}
	}

	function addQuestion() 
	{
		var question_form = $(".frm-question[style*='display: none']");
		var new_question_form = $(question_form).clone();
		var question_number = $('#questionnaire > form').length;
		var alternative_name = 'question_' + question_number;
		var alternative_id = alternative_name + '_alt_1';
		
		$(new_question_form).css('display', 'block');

		var question_type_select = $(new_question_form).children('select');
		var question_type_form_selector = '.question-type-' + $(question_type_select).val() + "[style*='display: none']";
		var cloned_question_type_form = $(question_type_form_selector).clone();

		if (question_type_select.val() == 'multiple-choice' || question_type_select.val() == 'checkboxes') {
			cloned_question_type_form.find('input').attr({'name': alternative_name, 'id': alternative_id});
			cloned_question_type_form.find('label').attr('for', alternative_id);
		}
		
		$(cloned_question_type_form).css('display', 'block');
		$(question_type_select).attr('data-current-question-type', $(question_type_select).val());

		$(new_question_form).children('.form-operations-list').before(cloned_question_type_form);

		$(new_question_form).css('z-index', $('#questionnaire > form').length - 1);
		$(new_question_form).attr('data-question-no', question_number);
		
		$('#btn-submit-questionnaire').before(new_question_form);

		switchFocusedSection(new_question_form);
	}

	function changeQuestionType(element) 
	{
		var current_question_type = $(element).attr('data-current-question-type');
		var new_question_type = $(element).val();
		var newly_selected_question_type  = "option[value='" + new_question_type + "']";

		$(element).children("option[selected='selected']").removeAttr('selected');
		$(newly_selected_question_type).attr('selected', 'selected');

		if (current_question_type == 'checkboxes' && new_question_type == 'multiple-choice') {
			// Replace checkboxes with radio buttons
			$(element).siblings("div[class*='question-type']").find("input[type='checkbox']").attr('type', 'radio');
		
		} else if (current_question_type == 'multiple-choice' && new_question_type == 'checkboxes') {
			// Replace radio buttons with checkboxes
			$(element).siblings("div[class*='question-type']").find("input[type='radio']").attr('type', 'checkbox');
		
		} else {
			var new_question_type_form_selector = '.question-type-' + new_question_type + "[style*='display: none']";
			var cloned_question_type_form = $(new_question_type_form_selector).clone();
			$(cloned_question_type_form).css('display', 'block');

			$(element).siblings("div[class*='question-type']").replaceWith(cloned_question_type_form);
		}

		$(element).attr('data-current-question-type', new_question_type);
	}

	function removeForm(element) 
	{
		$(element).closest('form').remove();
	}

	function duplicateForm(element) 
	{
		var question = $(element).closest('form');
		var cloned_question = $(question).clone();

		question.after(cloned_question);
		$(cloned_question).focus();
	}

	function moveForm(element, direction) 
	{
		var form = $(element).closest('form');
		var sibling_form;

		if (direction == 'up') {
			sibling_form = $(form).prev("form[id!='myForm']");
			if (sibling_form.length > 0) {
				$(sibling_form).before(form);
			}

		} else if (direction == 'down') {
			sibling_form = $(form).next("form");
			if (sibling_form.length > 0) {
				$(sibling_form).after(form);
			}
		}
	}

	function addHeadingAndDescription() 
	{
		var heading_and_description_form = $(".frm-heading-and-description[style*='display: none']");
		var new_heading_and_description_form = $(heading_and_description_form).clone();
		
		$(new_heading_and_description_form).css('display', 'block');

		$('#btn-submit-questionnaire').before(new_heading_and_description_form);

		switchFocusedSection(new_heading_and_description_form);
	}

	function preview() 
	{
		var preview_button = $("#toolbar button[onclick='preview()']");
		var text_areas = $('#questionnaire div.textarea');
		
		preview_button.toggleClass('active');
		
		if (preview_button.hasClass('active')) {
			$("#toolbar button:not(button[onclick='preview()'])").attr('disabled', 'disabled');
			preview_button.attr('data-preview', 'false');
			$("#questionnaire .form-operations-list, select, #questionnaire button:not([id='btn-submit-questionnaire'])").slideUp();
			$('.question-remove-alternative').hide();
			text_areas.css('resize', 'none');
			text_areas.attr({'disabled': 'disabled', 'contenteditable': 'false'});
			$('#questionnaire label').attr('contenteditable', 'false');
			$("#questionnaire input[type='checkbox'], #questionnaire input[type='radio']").removeAttr('disabled');
			$("#questionnaire input[type='text']").attr('disabled', 'disabled');
			
		} else {
			$("#toolbar button:not(button[onclick='preview()'])").removeAttr('disabled');
			preview_button.attr('data-preview', 'true');
			$("#questionnaire .form-operations-list, select, #questionnaire button:not([id='btn-submit-questionnaire'])").slideDown();
			$('.question-remove-alternative').show();
			text_areas.css('resize', 'vertical');
			text_areas.removeAttr('disabled');
			text_areas.attr('contenteditable', 'true');
			$('#questionnaire label').attr('contenteditable', 'true');
			$("#questionnaire input[type='checkbox'], #questionnaire input[type='radio']").attr('disabled', 'disabled');
			$("#questionnaire input[type='text']").removeAttr('disabled');
		}
		
		$('#btn-submit-questionnaire').toggle();
	}
	
	</script>
	</head>

	<body>
	
	<div id="questionnaire">
		<form id="myForm" onclick="switchFocusedSection(this)">
			<input type="text" style="font-size: 24px" value="Namnlöst formulär"><br>
			<div class="textarea">Beskrivning av formulär</div>
		</form>
		
		<button id="btn-submit-questionnaire" type="submit" onclick="submitQuestionnaire()" style="display: none">Skicka in</button>
	</div>
	
	<ul id="toolbar">
		<li><button type="button" onclick="addQuestion()" class="tooltip material-icons">add_circle<span class="tooltiptext">Lägg till fråga</span></button></li>
		<li><button type="button" onclick="addHeadingAndDescription()" class="tooltip material-icons">text_fields<span class="tooltiptext">Lägg till rubrik och beskrivning</span></button></li>
		<li><button type="button" onclick="addPicture()" class="tooltip material-icons">photo<span class="tooltiptext">Lägg till bild</span></button></li>
		<li><button type="button" onclick="preview()" class="tooltip material-icons">visibility<span class="tooltiptext">Förhandsgranska</span></button></li>
	</ul>

	<!-- Hidden elements -->
	<form class="frm-question" style="display: none; overflow: hidden; position: relative" onclick="switchFocusedSection(this)">
		<select onchange="changeQuestionType(this)" style="float: right">
			<option value="short-answer">Kort svar</option>
			<option value="paragraph">Stycke</option>
			<option value="checkboxes">Kryssrutor</option>
			<option value="multiple-choice" selected="selected">Flerval</option>
			<option value="ranked-choice">Rankat val</option>
		</select>

		<span style="display: block; overflow: hidden; padding-right: 10px";>
			<input type="text" value="Fråga" onfocus="switchFocusedSection(this)" style="width: 100%">
		</span>

		<ul class="form-operations-list">
			<li onclick="removeForm(this)" class="tooltip material-icons">delete<span class="tooltiptext">Ta bort</span></li>
			<li onclick="duplicateForm(this)" class="tooltip material-icons">content_copy<span class="tooltiptext">Duplicera</span></li>&nbsp;&nbsp;&nbsp;
			<li onclick="moveForm(this, 'up')" class="tooltip material-icons">arrow_upward<span class="tooltiptext">Flytta upp</span></li>
			<li onclick="moveForm(this, 'down')" class="tooltip material-icons">arrow_downward<span class="tooltiptext">Flytta ner</span></li>
		</ul>
	</form>

	<form class="frm-heading-and-description" style="display: none" onclick="switchFocusedSection(this)">
		<input type="text" value="Namnlös rubrik" onfocus="switchFocusedSection(this)"><br>
		<div class="textarea" contenteditable="true" onfocus="switchFocusedSection(this)">Beskrivning (valfritt)</div>

		<ul class="form-operations-list">
			<li onclick="removeForm(this)" class="tooltip material-icons">delete<span class="tooltiptext">Ta bort</span></li>
			<li onclick="duplicateForm(this)" class="tooltip material-icons">content_copy<span class="tooltiptext">Duplicera</span></li>&nbsp;&nbsp;&nbsp;
			<li onclick="moveForm(this, 'up')" class="tooltip material-icons">arrow_upward<span class="tooltiptext">Flytta upp</span></li>
			<li onclick="moveForm(this, 'down')" class="tooltip material-icons">arrow_downward<span class="tooltiptext">Flytta ner</span></li>
		</ul>
	</form>

	<!-- Question types -->
	<div class="question-type-short-answer" style="display: none">
		<input type="text" value="Kort svarstext" onfocus="switchFocusedSection(this)" disabled>
	</div>

	<div class="question-type-paragraph" style="display: none">
		<div class="textarea" onfocus="switchFocusedSection(this)" disabled>Lång svarstext</div>
	</div>

	<div class="question-type-multiple-choice" style="display: none">
		<div>
			<input type="radio" disabled="disabled">&nbsp;
			<label contenteditable="true">Alternativ<!--&nbsp;<span class="question-type-alternative-number">1</span>--></label>
		<span class="tooltip question-remove-alternative" onclick="removeQuestionAlternative(this)">&times;<span class="tooltiptext">Ta&nbsp;bort</span></span>
		</div>
		<button class="btn-add-alternative" type="button" onclick="addAnswerAlternative(this)">Lägg till alternativ</button>
	</div>

	<div class="question-type-checkboxes" style="display: none">
		<div>
			<input type="checkbox" disabled="disabled">&nbsp;
			<label contenteditable="true">Alternativ<!--&nbsp;<span class="question-type-alternative-number">1</span>--></label>
			<span class="tooltip question-remove-alternative" onclick="removeQuestionAlternative(this)">&times;<span class="tooltiptext">Ta&nbsp;bort</span></span>
		</div>
		<button class="btn-add-alternative" type="button" onclick="addAnswerAlternative(this)">Lägg till alternativ</button>
	</div>

	<div class="question-type-ranked-choice" style="display: none">
		<button class="btn-add-alternative" type="button" onclick="addAnswerAlternative(this)">Lägg till alternativ</button>
	</div>
	
	<!-- End of Question types -->

	<!-- End of Hidden elements -->

	</body>

</html>